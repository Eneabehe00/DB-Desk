{% extends "base.html" %}

{% block title %}{{ title }} - DB-Desk{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block extra_head %}
<style>
    .form-section {
        background: #f8fafc;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e2e8f0;
    }
    
    .form-section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .ricambi-selector {
        border: 1px solid #d1d5db;
        border-radius: 8px;
        background: white;
        min-height: 120px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .ricambio-item {
        padding: 0.75rem;
        border-bottom: 1px solid #f3f4f6;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .ricambio-item:hover {
        background-color: #f8fafc;
    }
    
    .ricambio-item.selected {
        background-color: #dbeafe;
        border-left: 4px solid #3b82f6;
    }
    
    .ricambio-item:last-child {
        border-bottom: none;
    }
    
    .ricambio-checkbox {
        width: 18px;
        height: 18px;
        accent-color: #3b82f6;
    }
    
    .ricambio-info {
        flex: 1;
    }
    
    .ricambio-code {
        font-weight: 600;
        color: #111827;
        font-size: 0.9rem;
    }
    
    .ricambio-desc {
        color: #6b7280;
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }
    
    .ricambio-stock {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-weight: 500;
    }
    
    .stock-available {
        background-color: #d1fae5;
        color: #065f46;
    }
    
    .stock-low {
        background-color: #fef3c7;
        color: #92400e;
    }
    
    .stock-empty {
        background-color: #fee2e2;
        color: #991b1b;
    }
    
    .ricambio-quantity {
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 4px;
        border-top: 1px solid #dee2e6;
    }
    
    .ricambio-quantity .form-label {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .ricambi-search {
        margin-bottom: 1rem;
    }
    
    .selected-count {
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 0.5rem;
    }
    
    .cliente-search-container {
        position: relative;
    }
    
    .cliente-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .cliente-item {
        padding: 0.75rem;
        border-bottom: 1px solid #f3f4f6;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .cliente-item:hover {
        background-color: #f8fafc;
    }
    
    .cliente-item:last-child {
        border-bottom: none;
    }
    
    .no-ricambi-message {
        text-align: center;
        padding: 2rem;
        color: #6b7280;
    }
    
    /* Stili per la selezione macchine */
    .macchine-selection-container {
        min-height: 120px;
    }
    
    .macchine-list {
        border: 1px solid #d1d5db;
        border-radius: 8px;
        background: white;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .macchina-item {
        padding: 0.75rem;
        border-bottom: 1px solid #f3f4f6;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .macchina-item:hover {
        background-color: #f8fafc;
    }
    
    .macchina-item.selected {
        background-color: #dbeafe;
        border-left: 4px solid #3b82f6;
    }
    
    .macchina-item:last-child {
        border-bottom: none;
    }
    
    .macchina-checkbox {
        width: 18px;
        height: 18px;
        accent-color: #3b82f6;
    }
    
    .macchina-info {
        flex: 1;
    }
    
    .macchina-code {
        font-weight: 600;
        color: #111827;
        font-size: 0.9rem;
    }
    
    .macchina-details {
        color: #6b7280;
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }
    
    .macchina-status {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-weight: 500;
    }
    
    .status-active {
        background-color: #d1fae5;
        color: #065f46;
    }
    
    .status-inactive {
        background-color: #fee2e2;
        color: #991b1b;
    }
    
    .selected-machines-count {
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 4px;
        text-align: center;
    }
    
    /* Miglioramenti per il layout desktop */
    @media (min-width: 992px) {
        .form-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
        }
        
        .form-section-title {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }
        
        /* Pulsanti azioni pi√π visibili */
        .btn-primary.btn-lg {
            font-weight: 600;
            padding: 0.75rem 2rem;
        }

        /* Pulsanti dopo ricambi - stile speciale */
        .btn-primary.btn-lg.px-4 {
            font-size: 1.1rem;
            font-weight: 600;
            min-width: 160px;
        }

        .btn-outline-primary.px-4 {
            min-width: 140px;
        }
        
        /* Colonna destra pi√π compatta */
        .col-lg-4 .form-section {
            margin-bottom: 1.5rem;
        }
        
        .col-lg-4 .form-section:last-child {
            margin-bottom: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3">
    <!-- Layout Desktop: Utilizzo completo dello spazio orizzontale -->
    <div class="d-none d-lg-block">
        <form method="POST" enctype="multipart/form-data" id="ticketForm">
            {{ form.hidden_tag() }}
            
            <div class="row g-4">
                <!-- Colonna Sinistra: Informazioni Principali + Ricambi -->
                <div class="col-lg-8">
                    <!-- Informazioni Principali -->
                    <div class="form-section mb-4">
                        <div class="form-section-title">
                            <i class="bi bi-info-circle text-primary"></i>
                            Informazioni Principali
                        </div>
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label class="form-label fw-semibold">Titolo del Ticket</label>
                                {{ form.titolo(class="form-control" + (" is-invalid" if form.titolo.errors else ""), placeholder="Descrivi brevemente il problema o la richiesta...") }}
                                {% if form.titolo.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.titolo.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% else %}
                                    <div class="invalid-feedback" id="titolo-error" style="display: none;">
                                        Il titolo √® obbligatorio
                                    </div>
                                {% endif %}
                                <div class="form-text">Sii specifico e conciso (max 200 caratteri)</div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-semibold">Cliente</label>
                                <div class="cliente-search-container">
                                    <input type="text" 
                                           id="cliente-search" 
                                           class="form-control{{ ' is-invalid' if form.cliente.errors else '' }}" 
                                           placeholder="Cerca cliente..."
                                           autocomplete="off"
                                           value="{{ form.cliente.data.ragione_sociale if form.cliente.data else '' }}">
                                    <input type="hidden" 
                                           id="cliente-id" 
                                           name="cliente" 
                                           value="{{ form.cliente.data.id if form.cliente.data else '' }}">
                                    
                                    <div id="cliente-dropdown" class="cliente-dropdown" style="display: none;">
                                    </div>
                                    
                                    {% if form.cliente.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.cliente.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="invalid-feedback d-block" id="cliente-error" style="display: none;">
                                            Seleziona un cliente
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Macchine Collegate -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-gear-wide-connected text-primary me-2"></i>
                                {{ form.macchine.label.text }}
                            </label>
                            
                            <!-- Container per le macchine -->
                            <div id="macchine-container" class="macchine-selection-container">
                                <div class="alert alert-info d-flex align-items-center" id="no-client-message">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <small>Seleziona prima un cliente per vedere le macchine disponibili</small>
                                </div>
                                
                                <div id="macchine-list" class="macchine-list" style="display: none;">
                                    <!-- Le macchine verranno caricate dinamicamente qui -->
                                </div>
                                
                                <div class="alert alert-warning d-flex align-items-center" id="no-machines-message" style="display: none;">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <small>Nessuna macchina trovata per questo cliente</small>
                                </div>
                            </div>
                            
                            <!-- Campo nascosto per mantenere compatibilit√† con il form -->
                            {{ form.macchine(style="display: none;", id="macchine-select") }}
                            
                            {% if form.macchine.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.macchine.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">{{ form.macchine.description }}</div>
                        </div>

                        <!-- Tipo operazione macchine -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-tools text-warning me-2"></i>
                                {{ form.tipo_operazione_macchine.label.text }}
                            </label>
                            {{ form.tipo_operazione_macchine(class="form-select" + (" is-invalid" if form.tipo_operazione_macchine.errors else ""), id="tipo-operazione-select") }}
                            {% if form.tipo_operazione_macchine.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.tipo_operazione_macchine.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">{{ form.tipo_operazione_macchine.description }}</div>
                        </div>

                        <!-- Macchine sostitutive (visibile solo per riparazione con prestito) -->
                        <div class="col-md-4 mb-3" id="macchine-sostitutive-container" style="display: none;">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-arrow-repeat text-info me-2"></i>
                                {{ form.macchine_sostitutive.label.text }}
                            </label>
                            
                            <!-- Container per le macchine sostitutive -->
                            <div id="macchine-sostitutive-list-container" class="macchine-selection-container">
                                <div class="alert alert-info d-flex align-items-center" id="no-client-message-sostitutive">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <small>Seleziona "Riparazione in sede con prestito" per vedere le macchine disponibili</small>
                                </div>
                                
                                <div id="macchine-sostitutive-list" class="macchine-list" style="display: none;">
                                    <!-- Le macchine sostitutive verranno caricate dinamicamente qui -->
                                </div>
                                
                                <div class="alert alert-warning d-flex align-items-center" id="no-machines-message-sostitutive" style="display: none;">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <small>Nessuna macchina disponibile per il prestito</small>
                                </div>
                            </div>
                            
                            <!-- Campo nascosto per mantenere compatibilit√† con il form -->
                            {{ form.macchine_sostitutive(style="display: none;", id="macchine-sostitutive-select") }}
                            
                            {% if form.macchine_sostitutive.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.macchine_sostitutive.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">{{ form.macchine_sostitutive.description }}</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Descrizione Dettagliata</label>
                            {{ form.descrizione(class="form-control" + (" is-invalid" if form.descrizione.errors else ""), rows="5", placeholder="Descrivi il problema in dettaglio, includi informazioni su quando si verifica, messaggi di errore, passi per riprodurlo...") }}
                            {% if form.descrizione.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.descrizione.errors %}{{ error }}{% endfor %}
                                </div>
                            {% else %}
                                <div class="invalid-feedback" id="descrizione-error" style="display: none;">
                                    La descrizione √® obbligatoria
                                </div>
                            {% endif %}
                            <div class="form-text">Pi√π dettagli fornisci, pi√π veloce sar√† la risoluzione</div>
                        </div>

                        <!-- Allegato iniziale (opzionale) -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Allegato (opzionale)</label>
                            <input type="file" name="file" class="form-control" />
                            <div class="form-text">Formati permessi: {{ ', '.join(allowed_attach_exts) if allowed_attach_exts else 'pdf, immagini, zip, log' }}</div>
                        </div>
                    </div>
                    
                    <!-- Ricambi Necessari (spostato nella colonna sinistra) -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="bi bi-box-seam text-success"></i>
                            Ricambi Necessari
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="ricambi-search">
                                    <input type="text" 
                                           id="ricambi-search" 
                                           class="form-control" 
                                           placeholder="üîç Cerca ricambi per codice o descrizione...">
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="selected-count" id="selected-count">
                                    Nessun ricambio selezionato
                                </div>
                            </div>
                        </div>
                        
                        <div class="ricambi-selector" id="ricambi-selector">
                            <!-- Popolato via JavaScript -->
                        </div>
                        
                        <div class="form-text mt-2">
                            <i class="bi bi-info-circle"></i>
                            <strong>Importante:</strong> I ricambi selezionati verranno automaticamente sottratti dal magazzino quando il ticket sar√† chiuso.
                        </div>
                    </div>

                    <!-- Pulsanti Azioni - Subito dopo i ricambi -->
                    <div class="mt-4 mb-4">
                        <div class="d-flex gap-3 justify-content-start">
                            <button type="submit" class="btn btn-primary btn-lg px-4 py-2">
                                <i class="bi bi-check-lg"></i>
                                Crea Ticket
                            </button>
                            <button type="button" class="btn btn-outline-primary px-4 py-2" onclick="saveDraft()">
                                <i class="bi bi-save"></i>
                                Salva Bozza
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Colonna Destra: Configurazione e Dettagli -->
                <div class="col-lg-4">
                    <!-- Classificazione e Priorit√† -->
                    <div class="form-section mb-4">
                        <div class="form-section-title">
                            <i class="bi bi-tags text-warning"></i>
                            Classificazione e Priorit√†
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Categoria</label>
                            {{ form.categoria(class="form-select") }}
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Priorit√†</label>
                            {{ form.priorita(class="form-select") }}
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Stato</label>
                            {{ form.stato(class="form-select") }}
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Assegnato a</label>
                            {{ form.assigned_to(class="form-select") }}
                            <div class="form-text">Se non selezionato, verr√† assegnato a te</div>
                        </div>
                    </div>
                    
                    <!-- Pianificazione -->
                    <div class="form-section mb-4">
                        <div class="form-section-title">
                            <i class="bi bi-calendar text-info"></i>
                            Pianificazione
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Scadenza</label>
                            {{ form.due_date(class="form-control", type="datetime-local") }}
                            <div class="form-text">Quando deve essere completato questo ticket?</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Tempo Stimato</label>
                            <div class="input-group">
                                {{ form.tempo_stimato(class="form-control", placeholder="60") }}
                                <span class="input-group-text">minuti</span>
                            </div>
                            <div class="form-text">Stima approssimativa per la risoluzione</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Tag</label>
                            {{ form.tags(class="form-control", placeholder="hardware, software, urgente...") }}
                            <div class="form-text">Separa i tag con virgole</div>
                        </div>
                    </div>
                    
                    <!-- Note Interne -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="bi bi-sticky text-secondary"></i>
                            Note Interne
                        </div>
                        
                        <div class="mb-3">
                            {{ form.note_interne(class="form-control", rows="3", placeholder="Note visibili solo al team interno...") }}
                            <div class="form-text">Queste note non saranno visibili al cliente</div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Layout Tablet: Semplificato -->
    <div class="d-lg-none">
        <div class="row justify-content-center">
            <div class="col-12">
                <form method="POST" enctype="multipart/form-data" id="ticketFormTablet">
                    {{ form.hidden_tag() }}
                    
                    <!-- Informazioni Principali -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="bi bi-info-circle text-primary"></i>
                            Nuovo Ticket
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Titolo del Ticket</label>
                            {{ form.titolo(class="form-control" + (" is-invalid" if form.titolo.errors else ""), placeholder="Descrivi brevemente il problema...") }}
                            {% if form.titolo.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.titolo.errors %}{{ error }}{% endfor %}
                                </div>
                            {% else %}
                                <div class="invalid-feedback" id="titolo-error-tablet" style="display: none;">
                                    Il titolo √® obbligatorio
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Cliente</label>
                            <div class="cliente-search-container">
                                <input type="text" 
                                       id="cliente-search-tablet" 
                                       class="form-control{{ ' is-invalid' if form.cliente.errors else '' }}" 
                                       placeholder="Cerca cliente..."
                                       autocomplete="off"
                                       value="{{ form.cliente.data.ragione_sociale if form.cliente.data else '' }}">
                                <input type="hidden" 
                                       id="cliente-id-tablet" 
                                       name="cliente" 
                                       value="{{ form.cliente.data.id if form.cliente.data else '' }}">
                                
                                <div id="cliente-dropdown-tablet" class="cliente-dropdown" style="display: none;">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-gear-wide-connected text-primary me-2"></i>
                                Macchine Collegate
                            </label>
                            
                            <!-- Container per le macchine tablet -->
                            <div id="macchine-container-tablet" class="macchine-selection-container">
                                <div class="alert alert-info d-flex align-items-center" id="no-client-message-tablet">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <small>Seleziona prima un cliente per vedere le macchine disponibili</small>
                                </div>
                                
                                <div id="macchine-list-tablet" class="macchine-list" style="display: none;">
                                    <!-- Le macchine verranno caricate dinamicamente qui -->
                                </div>
                                
                                <div class="alert alert-warning d-flex align-items-center" id="no-machines-message-tablet" style="display: none;">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <small>Nessuna macchina trovata per questo cliente</small>
                                </div>
                            </div>
                            
                            <!-- Campo nascosto per mantenere compatibilit√† con il form -->
                            <select name="macchine" id="macchine-select-tablet" multiple style="display: none;"></select>
                            
                            <div class="form-text">{{ form.macchine.description }}</div>
                        </div>
                        
                        <!-- Tipo operazione macchine tablet -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-tools text-warning me-2"></i>
                                {{ form.tipo_operazione_macchine.label.text }}
                            </label>
                            {{ form.tipo_operazione_macchine(class="form-select" + (" is-invalid" if form.tipo_operazione_macchine.errors else ""), id="tipo-operazione-select-tablet") }}
                            {% if form.tipo_operazione_macchine.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.tipo_operazione_macchine.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">{{ form.tipo_operazione_macchine.description }}</div>
                        </div>

                        <!-- Macchine sostitutive tablet (visibile solo per riparazione con prestito) -->
                        <div class="mb-3" id="macchine-sostitutive-container-tablet" style="display: none;">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-arrow-repeat text-info me-2"></i>
                                {{ form.macchine_sostitutive.label.text }}
                            </label>
                            
                            <!-- Container per le macchine sostitutive tablet -->
                            <div id="macchine-sostitutive-list-container-tablet" class="macchine-selection-container">
                                <div class="alert alert-info d-flex align-items-center" id="no-client-message-sostitutive-tablet">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <small>Seleziona "Riparazione in sede con prestito" per vedere le macchine disponibili</small>
                                </div>
                                
                                <div id="macchine-sostitutive-list-tablet" class="macchine-list" style="display: none;">
                                    <!-- Le macchine sostitutive verranno caricate dinamicamente qui -->
                                </div>
                                
                                <div class="alert alert-warning d-flex align-items-center" id="no-machines-message-sostitutive-tablet" style="display: none;">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <small>Nessuna macchina disponibile per il prestito</small>
                                </div>
                            </div>
                            
                            <!-- Campo nascosto per mantenere compatibilit√† con il form -->
                            <select name="macchine_sostitutive" id="macchine-sostitutive-select-tablet" multiple style="display: none;"></select>
                            
                            <div class="form-text">{{ form.macchine_sostitutive.description }}</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Descrizione</label>
                            {{ form.descrizione(class="form-control" + (" is-invalid" if form.descrizione.errors else ""), rows="4", placeholder="Descrivi il problema in dettaglio...") }}
                            {% if form.descrizione.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.descrizione.errors %}{{ error }}{% endfor %}
                                </div>
                            {% else %}
                                <div class="invalid-feedback" id="descrizione-error-tablet" style="display: none;">
                                    La descrizione √® obbligatoria
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Stato</label>
                                {{ form.stato(class="form-select") }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Assegnato a</label>
                                {{ form.assigned_to(class="form-select") }}
                                <div class="form-text">Se non selezionato, verr√† assegnato a te</div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Scadenza</label>
                                {{ form.due_date(class="form-control", type="datetime-local") }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Tempo Stimato</label>
                                <div class="input-group">
                                    {{ form.tempo_stimato(class="form-control", placeholder="60") }}
                                    <span class="input-group-text">min</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Allegato -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Allegato (opzionale)</label>
                            <input type="file" name="file" class="form-control" />
                        </div>
                    </div>
                    
                    <!-- Ricambi Necessari (semplificato per tablet) -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="bi bi-box-seam text-success"></i>
                            Ricambi Necessari
                        </div>
                        
                        <div class="ricambi-search mb-3">
                            <input type="text" 
                                   id="ricambi-search-tablet" 
                                   class="form-control" 
                                   placeholder="üîç Cerca ricambi...">
                        </div>
                        
                        <div class="ricambi-selector" id="ricambi-selector-tablet">
                            <!-- Popolato via JavaScript -->
                        </div>
                        
                        <div class="selected-count" id="selected-count-tablet">
                            Nessun ricambio selezionato
                        </div>
                    </div>
                    
                    <!-- Azioni Tablet -->
                    <div class="d-flex flex-column gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-lg"></i>
                            Crea Ticket
                        </button>
                        <a href="{{ url_for('tickets.list_tickets') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i>
                            Torna alla Lista
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dati ricambi (popolati dal server)
let ricambiData = {{ form.ricambi_data | tojson | safe if form.ricambi_data else '[]' }};

let selectedRicambi = new Map(); // Map per memorizzare ricambioId -> quantit√†

// Inizializza con i dati esistenti se in modifica
{% if form.ricambi_necessari.data %}
    {% for ricambio_id in form.ricambi_necessari.data %}
        {% set quantity = form.ricambi_quantities.get(ricambio_id, 1) if form.ricambi_quantities else 1 %}
        selectedRicambi.set({{ ricambio_id }}, {{ quantity }});
    {% endfor %}
{% endif %}

// Inizializza la selezione ricambi
document.addEventListener('DOMContentLoaded', function() {
    renderRicambi();
    renderRicambiTablet();
    updateSelectedCount();
    
    // Focus sul primo campo
    const titoloField = document.getElementById('titolo');
    if (titoloField) titoloField.focus();
});

function renderRicambi(filteredData = null) {
    const container = document.getElementById('ricambi-selector');
    if (!container) return;
    const data = filteredData || ricambiData;
    
    if (data.length === 0) {
        container.innerHTML = `
            <div class="no-ricambi-message">
                <i class="bi bi-search fs-1 text-muted"></i>
                <p class="mt-2">Nessun ricambio trovato</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = data.map(ricambio => {
        const isSelected = selectedRicambi.has(ricambio.id);
        const currentQuantity = selectedRicambi.get(ricambio.id) || 1;

        // Determina la classe CSS basata sullo stock
        let stockClass, stockIcon;
        if (ricambio.stock === 0) {
            stockClass = 'stock-empty';
            stockIcon = 'bi-x-circle';
        } else if (ricambio.stock <= 5) {
            stockClass = 'stock-low';
            stockIcon = 'bi-exclamation-triangle';
        } else {
            stockClass = 'stock-available';
            stockIcon = 'bi-check-circle';
        }

        const stockText = ricambio.stock > 0 ? `${ricambio.stock} pz` : 'Esaurito';

        return `
            <div class="ricambio-item ${isSelected ? 'selected' : ''}" 
                 onclick="toggleRicambio(${ricambio.id})">
                <input type="checkbox" 
                       class="ricambio-checkbox" 
                       ${isSelected ? 'checked' : ''}
                       onchange="event.stopPropagation(); toggleRicambio(${ricambio.id})">
                <div class="ricambio-info">
                    <div class="ricambio-code">${ricambio.code}</div>
                    <div class="ricambio-desc">${ricambio.description}</div>
                </div>
                <div class="ricambio-stock ${stockClass}">
                    <i class="bi ${stockIcon}"></i>
                    ${stockText}
                </div>
                ${isSelected ? `
                    <div class="ricambio-quantity" onclick="event.stopPropagation();">
                        <label class="form-label mb-1">Quantit√†:</label>
                        <input type="number" 
                               class="form-control form-control-sm" 
                               value="${currentQuantity}" 
                               min="1" 
                               max="${ricambio.stock}" 
                               onchange="updateQuantity(${ricambio.id}, this.value)"
                               style="width: 80px;">
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

// Funzione per renderizzare ricambi su tablet (semplificata)
function renderRicambiTablet(filteredData = null) {
    const container = document.getElementById('ricambi-selector-tablet');
    if (!container) return;
    const data = filteredData || ricambiData;
    
    if (data.length === 0) {
        container.innerHTML = `
            <div class="no-ricambi-message">
                <i class="bi bi-search fs-4 text-muted"></i>
                <p class="mb-0">Nessun ricambio trovato</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = data.map(ricambio => {
        const isSelected = selectedRicambi.has(ricambio.id);
        const currentQuantity = selectedRicambi.get(ricambio.id) || 1;
        
        const stockClass = ricambio.stock > 0 ? 'text-success' : 'text-danger';
        const stockIcon = ricambio.stock > 0 ? 'bi-check-circle' : 'bi-x-circle';
        const stockText = ricambio.stock > 0 ? `${ricambio.stock} pz` : 'Esaurito';

        return `
            <div class="ricambio-item ${isSelected ? 'selected' : ''}" 
                 onclick="toggleRicambio(${ricambio.id})">
                <input type="checkbox" 
                       class="ricambio-checkbox" 
                       ${isSelected ? 'checked' : ''}
                       onchange="event.stopPropagation(); toggleRicambio(${ricambio.id})">
                <div class="ricambio-info">
                    <div class="ricambio-code">${ricambio.code}</div>
                    <div class="ricambio-desc">${ricambio.description.substring(0, 30)}${ricambio.description.length > 30 ? '...' : ''}</div>
                </div>
                <div class="ricambio-stock ${stockClass}">
                    <i class="bi ${stockIcon}"></i>
                    ${stockText}
                </div>
            </div>
        `;
    }).join('');
}

function toggleRicambio(ricambioId) {
    if (selectedRicambi.has(ricambioId)) {
        selectedRicambi.delete(ricambioId);
    } else {
        selectedRicambi.set(ricambioId, 1); // Quantit√† di default
    }
    
    // Re-render per entrambi i layout
    renderRicambi();
    renderRicambiTablet();
    updateSelectedCount();
    updateHiddenField();
}

function updateQuantity(ricambioId, quantity) {
    const qty = parseInt(quantity) || 1;
    if (selectedRicambi.has(ricambioId)) {
        selectedRicambi.set(ricambioId, qty);
        updateHiddenField();
    }
}

function updateSelectedCount() {
    const count = selectedRicambi.size;
    const countElement = document.getElementById('selected-count');
    const countElementTablet = document.getElementById('selected-count-tablet');
    
    const message = count === 0 ? 
        'Nessun ricambio selezionato' : 
        `<i class="bi bi-check-circle text-success"></i> ${count} ricambi selezionati (${Array.from(selectedRicambi.values()).reduce((sum, qty) => sum + qty, 0)} pezzi totali)`;
    
    const className = count === 0 ? 'selected-count text-muted' : 'selected-count text-primary fw-semibold';
    
    if (countElement) {
        countElement.innerHTML = message;
        countElement.className = className;
    }
    
    if (countElementTablet) {
        countElementTablet.innerHTML = message;
        countElementTablet.className = className;
    }
}

function updateHiddenField() {
    // Crea input hidden per i ricambi selezionati con quantit√†
    const form = document.getElementById('ticketForm') || document.getElementById('ticketFormTablet');
    
    // Rimuovi input esistenti
    const existingInputs = form.querySelectorAll('input[name="ricambi_necessari"], input[name^="ricambio_quantity_"]');
    existingInputs.forEach(input => input.remove());
    
    // Aggiungi nuovi input per ricambi e quantit√†
    selectedRicambi.forEach((quantity, ricambioId) => {
        // Input per l'ID del ricambio
        const ricambioInput = document.createElement('input');
        ricambioInput.type = 'hidden';
        ricambioInput.name = 'ricambi_necessari';
        ricambioInput.value = ricambioId;
        form.appendChild(ricambioInput);
        
        // Input per la quantit√†
        const quantityInput = document.createElement('input');
        quantityInput.type = 'hidden';
        quantityInput.name = `ricambio_quantity_${ricambioId}`;
        quantityInput.value = quantity;
        form.appendChild(quantityInput);
    });
}

// Ricerca ricambi (desktop)
const ricambiSearchDesktop = document.getElementById('ricambi-search');
if (ricambiSearchDesktop) {
    ricambiSearchDesktop.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        
        if (query === '') {
            renderRicambi();
            return;
        }
        
        const filtered = ricambiData.filter(ricambio => 
            ricambio.code.toLowerCase().includes(query) ||
            ricambio.description.toLowerCase().includes(query)
        );
        
        renderRicambi(filtered);
    });
}

// Ricerca ricambi (tablet)
const ricambiSearchTablet = document.getElementById('ricambi-search-tablet');
if (ricambiSearchTablet) {
    ricambiSearchTablet.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        
        if (query === '') {
            renderRicambiTablet();
            return;
        }
        
        const filtered = ricambiData.filter(ricambio => 
            ricambio.code.toLowerCase().includes(query) ||
            ricambio.description.toLowerCase().includes(query)
        );
        
        renderRicambiTablet(filtered);
    });
}

// Variabile globale per tenere traccia delle macchine selezionate
let selectedMachines = new Set();

// Funzione per caricare le macchine associate a un cliente
function loadClientMachines(clienteId) {
    const macchineContainer = document.getElementById('macchine-container');
    const macchineContainerTablet = document.getElementById('macchine-container-tablet');
    const macchineSelect = document.getElementById('macchine-select');
    const macchineSelectTablet = document.getElementById('macchine-select-tablet');
    
    if (!clienteId || clienteId === '0') {
        // Mostra messaggio "seleziona cliente"
        showNoClientMessage();
        clearMachineSelections();
        return;
    }
    
    // Mostra loading
    showMachineLoading();
    
    fetch(`{{ url_for('tickets.get_client_machines', cliente_id=0) }}`.replace('0', clienteId))
        .then(response => response.json())
        .then(data => {
            if (data.success && data.macchine && data.macchine.length > 0) {
                renderMachineList(data.macchine);
                updateHiddenMachineSelects(data.macchine);
            } else {
                showNoMachinesMessage();
                clearMachineSelections();
            }
        })
        .catch(error => {
            console.error('Errore nel caricamento delle macchine:', error);
            showMachineError();
            clearMachineSelections();
        });
}

function showNoClientMessage() {
    // Desktop
    const noClientMsg = document.getElementById('no-client-message');
    const machineList = document.getElementById('macchine-list');
    const noMachinesMsg = document.getElementById('no-machines-message');
    
    if (noClientMsg) noClientMsg.style.display = 'block';
    if (machineList) machineList.style.display = 'none';
    if (noMachinesMsg) noMachinesMsg.style.display = 'none';
    
    // Tablet
    const noClientMsgTablet = document.getElementById('no-client-message-tablet');
    const machineListTablet = document.getElementById('macchine-list-tablet');
    const noMachinesMsgTablet = document.getElementById('no-machines-message-tablet');
    
    if (noClientMsgTablet) noClientMsgTablet.style.display = 'block';
    if (machineListTablet) machineListTablet.style.display = 'none';
    if (noMachinesMsgTablet) noMachinesMsgTablet.style.display = 'none';
}

function showMachineLoading() {
    // Desktop
    const noClientMsg = document.getElementById('no-client-message');
    const machineList = document.getElementById('macchine-list');
    const noMachinesMsg = document.getElementById('no-machines-message');
    
    if (noClientMsg) noClientMsg.style.display = 'none';
    if (machineList) {
        machineList.style.display = 'block';
        machineList.innerHTML = `
            <div class="text-center p-3">
                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                <span>Caricamento macchine...</span>
            </div>
        `;
    }
    if (noMachinesMsg) noMachinesMsg.style.display = 'none';
    
    // Tablet
    const noClientMsgTablet = document.getElementById('no-client-message-tablet');
    const machineListTablet = document.getElementById('macchine-list-tablet');
    const noMachinesMsgTablet = document.getElementById('no-machines-message-tablet');
    
    if (noClientMsgTablet) noClientMsgTablet.style.display = 'none';
    if (machineListTablet) {
        machineListTablet.style.display = 'block';
        machineListTablet.innerHTML = `
            <div class="text-center p-3">
                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                <span>Caricamento macchine...</span>
            </div>
        `;
    }
    if (noMachinesMsgTablet) noMachinesMsgTablet.style.display = 'none';
}

function showNoMachinesMessage() {
    // Desktop
    const noClientMsg = document.getElementById('no-client-message');
    const machineList = document.getElementById('macchine-list');
    const noMachinesMsg = document.getElementById('no-machines-message');
    
    if (noClientMsg) noClientMsg.style.display = 'none';
    if (machineList) machineList.style.display = 'none';
    if (noMachinesMsg) noMachinesMsg.style.display = 'block';
    
    // Tablet
    const noClientMsgTablet = document.getElementById('no-client-message-tablet');
    const machineListTablet = document.getElementById('macchine-list-tablet');
    const noMachinesMsgTablet = document.getElementById('no-machines-message-tablet');
    
    if (noClientMsgTablet) noClientMsgTablet.style.display = 'none';
    if (machineListTablet) machineListTablet.style.display = 'none';
    if (noMachinesMsgTablet) noMachinesMsgTablet.style.display = 'block';
}

function showMachineError() {
    // Desktop
    const machineList = document.getElementById('macchine-list');
    if (machineList) {
        machineList.style.display = 'block';
        machineList.innerHTML = `
            <div class="text-center p-3 text-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <span>Errore nel caricamento delle macchine</span>
            </div>
        `;
    }
    
    // Tablet
    const machineListTablet = document.getElementById('macchine-list-tablet');
    if (machineListTablet) {
        machineListTablet.style.display = 'block';
        machineListTablet.innerHTML = `
            <div class="text-center p-3 text-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <span>Errore nel caricamento delle macchine</span>
            </div>
        `;
    }
}

function renderMachineList(machines) {
    const machineList = document.getElementById('macchine-list');
    const machineListTablet = document.getElementById('macchine-list-tablet');
    
    // Desktop
    if (machineList) {
        const noClientMsg = document.getElementById('no-client-message');
        const noMachinesMsg = document.getElementById('no-machines-message');
        
        if (noClientMsg) noClientMsg.style.display = 'none';
        if (noMachinesMsg) noMachinesMsg.style.display = 'none';
        
        machineList.style.display = 'block';
        machineList.innerHTML = machines.map(machine => {
            const isSelected = selectedMachines.has(machine.id);
            return `
                <div class="macchina-item ${isSelected ? 'selected' : ''}" onclick="toggleMachine(${machine.id})">
                    <input type="checkbox" 
                           class="macchina-checkbox" 
                           ${isSelected ? 'checked' : ''}
                           onchange="event.stopPropagation(); toggleMachine(${machine.id})">
                    <div class="macchina-info">
                        <div class="macchina-code">${machine.codice}</div>
                        <div class="macchina-details">${machine.marca} ${machine.modello}</div>
                    </div>
                    <div class="macchina-status status-active">
                        <i class="bi bi-check-circle"></i>
                        Attiva
                    </div>
                </div>
            `;
        }).join('');
        
        // Aggiungi contatore
        const selectedCount = selectedMachines.size;
        if (selectedCount > 0) {
            machineList.innerHTML += `
                <div class="selected-machines-count">
                    <i class="bi bi-check-circle text-success me-1"></i>
                    ${selectedCount} macchina/e selezionata/e
                </div>
            `;
        }
    }
    
    // Tablet
    if (machineListTablet) {
        const noClientMsgTablet = document.getElementById('no-client-message-tablet');
        const noMachinesMsgTablet = document.getElementById('no-machines-message-tablet');
        
        if (noClientMsgTablet) noClientMsgTablet.style.display = 'none';
        if (noMachinesMsgTablet) noMachinesMsgTablet.style.display = 'none';
        
        machineListTablet.style.display = 'block';
        machineListTablet.innerHTML = machines.map(machine => {
            const isSelected = selectedMachines.has(machine.id);
            return `
                <div class="macchina-item ${isSelected ? 'selected' : ''}" onclick="toggleMachine(${machine.id})">
                    <input type="checkbox" 
                           class="macchina-checkbox" 
                           ${isSelected ? 'checked' : ''}
                           onchange="event.stopPropagation(); toggleMachine(${machine.id})">
                    <div class="macchina-info">
                        <div class="macchina-code">${machine.codice}</div>
                        <div class="macchina-details">${machine.marca} ${machine.modello}</div>
                    </div>
                    <div class="macchina-status status-active">
                        <i class="bi bi-check-circle"></i>
                        Attiva
                    </div>
                </div>
            `;
        }).join('');
        
        // Aggiungi contatore
        const selectedCount = selectedMachines.size;
        if (selectedCount > 0) {
            machineListTablet.innerHTML += `
                <div class="selected-machines-count">
                    <i class="bi bi-check-circle text-success me-1"></i>
                    ${selectedCount} macchina/e selezionata/e
                </div>
            `;
        }
    }
}

function toggleMachine(machineId) {
    if (selectedMachines.has(machineId)) {
        selectedMachines.delete(machineId);
    } else {
        selectedMachines.add(machineId);
    }
    
    // Aggiorna la visualizzazione
    updateMachineDisplay();
    updateHiddenMachineFields();
}

function updateMachineDisplay() {
    // Aggiorna lo stato visivo delle macchine
    document.querySelectorAll('.macchina-item').forEach(item => {
        const checkbox = item.querySelector('.macchina-checkbox');
        const machineId = parseInt(checkbox.onchange.toString().match(/toggleMachine\((\d+)\)/)[1]);
        
        if (selectedMachines.has(machineId)) {
            item.classList.add('selected');
            checkbox.checked = true;
        } else {
            item.classList.remove('selected');
            checkbox.checked = false;
        }
    });
    
    // Aggiorna i contatori
    const selectedCount = selectedMachines.size;
    const countMessage = selectedCount > 0 ? 
        `<i class="bi bi-check-circle text-success me-1"></i> ${selectedCount} macchina/e selezionata/e` : '';
    
    document.querySelectorAll('.selected-machines-count').forEach(counter => {
        if (selectedCount > 0) {
            counter.innerHTML = countMessage;
            counter.style.display = 'block';
        } else {
            counter.style.display = 'none';
        }
    });
}

function updateHiddenMachineFields() {
    const macchineSelect = document.getElementById('macchine-select');
    const macchineSelectTablet = document.getElementById('macchine-select-tablet');
    
    // Aggiorna il campo nascosto desktop
    if (macchineSelect) {
        macchineSelect.innerHTML = '';
        selectedMachines.forEach(machineId => {
            const option = document.createElement('option');
            option.value = machineId;
            option.selected = true;
            macchineSelect.appendChild(option);
        });
    }
    
    // Aggiorna il campo nascosto tablet
    if (macchineSelectTablet) {
        macchineSelectTablet.innerHTML = '';
        selectedMachines.forEach(machineId => {
            const option = document.createElement('option');
            option.value = machineId;
            option.selected = true;
            macchineSelectTablet.appendChild(option);
        });
    }
}

function updateHiddenMachineSelects(machines) {
    const macchineSelect = document.getElementById('macchine-select');
    const macchineSelectTablet = document.getElementById('macchine-select-tablet');
    
    // Popola le opzioni per compatibilit√† con il form
    [macchineSelect, macchineSelectTablet].forEach(select => {
        if (select) {
            select.innerHTML = '';
            machines.forEach(machine => {
                const option = document.createElement('option');
                option.value = machine.id;
                option.textContent = `${machine.codice} - ${machine.marca} ${machine.modello}`;
                select.appendChild(option);
            });
        }
    });
    
    // Aggiorna le selezioni
    updateHiddenMachineFields();
}

function clearMachineSelections() {
    selectedMachines.clear();
    updateHiddenMachineFields();
}

// Cliente autocomplete (desktop)
let searchTimeout;
function setupClienteAutocomplete(searchId, hiddenId, dropdownId) {
    const clienteSearch = document.getElementById(searchId);
    const clienteId = document.getElementById(hiddenId);
    const clienteDropdown = document.getElementById(dropdownId);

    if (clienteSearch && clienteId && clienteDropdown) {
        clienteSearch.addEventListener('input', function() {
            const query = this.value.trim();
            
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                clienteDropdown.style.display = 'none';
                clienteId.value = '';
                return;
            }
            
            searchTimeout = setTimeout(() => {
                fetch(`{{ url_for('tickets.search_clients') }}?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        clienteDropdown.innerHTML = '';
                        
                        if (data.length === 0) {
                            clienteDropdown.innerHTML = '<div class="cliente-item text-muted">Nessun cliente trovato</div>';
                        } else {
                            data.forEach(cliente => {
                                const item = document.createElement('div');
                                item.className = 'cliente-item';
                                item.innerHTML = `
                                    <div class="fw-medium">${cliente.text}</div>
                                    <small class="text-muted">${cliente.subtitle}</small>
                                `;
                                item.addEventListener('click', function() {
                                    clienteSearch.value = cliente.text;
                                    clienteId.value = cliente.id;
                                    clienteDropdown.style.display = 'none';
                                    
                                    // Carica le macchine per questo cliente
                                    loadClientMachines(cliente.id);
                                });
                                clienteDropdown.appendChild(item);
                            });
                        }
                        
                        clienteDropdown.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Errore nella ricerca clienti:', error);
                        clienteDropdown.innerHTML = '<div class="cliente-item text-danger">Errore nella ricerca</div>';
                        clienteDropdown.style.display = 'block';
                    });
            }, 300);
        });

        // Nasconde il dropdown quando si clicca altrove
        document.addEventListener('click', function(e) {
            if (!clienteSearch.contains(e.target) && !clienteDropdown.contains(e.target)) {
                clienteDropdown.style.display = 'none';
            }
        });
    }
}

// Inizializza autocomplete per entrambi i layout
setupClienteAutocomplete('cliente-search', 'cliente-id', 'cliente-dropdown');
setupClienteAutocomplete('cliente-search-tablet', 'cliente-id-tablet', 'cliente-dropdown-tablet');

// Aggiungi event listener per ricaricare macchine disponibili quando cambia cliente
document.getElementById('cliente-id').addEventListener('change', function() {
    const tipoOperazione = document.getElementById('tipo-operazione-select')?.value;
    if (tipoOperazione === 'riparazione_sede_con_prestito') {
        loadMacchineDisponibili();
    }
});

document.getElementById('cliente-id-tablet').addEventListener('change', function() {
    const tipoOperazione = document.getElementById('tipo-operazione-select-tablet')?.value;
    if (tipoOperazione === 'riparazione_sede_con_prestito') {
        loadMacchineDisponibiliTablet();
    }
});

// Auto-resize textarea
document.querySelectorAll('textarea').forEach(textarea => {
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
});

// Controllo lunghezza titolo
document.getElementById('titolo').addEventListener('input', function() {
    const maxLength = 200;
    const currentLength = this.value.length;
    const remaining = maxLength - currentLength;
    
    let counter = this.parentNode.querySelector('.char-counter');
    if (!counter) {
        counter = document.createElement('div');
        counter.className = 'form-text char-counter';
        this.parentNode.appendChild(counter);
    }
    
    counter.textContent = `${currentLength}/${maxLength} caratteri`;
    counter.className = `form-text char-counter ${remaining < 20 ? 'text-warning' : ''}`;
});

// Validazione data scadenza (solo avviso, non blocca il submit)
const dueDateField = document.getElementById('due_date');
if (dueDateField) {
    dueDateField.addEventListener('change', function() {
        const selectedDate = new Date(this.value);
        const now = new Date();
        
        if (selectedDate < now) {
            let feedback = this.parentNode.querySelector('.form-text.date-warning');
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.className = 'form-text date-warning text-warning';
                this.parentNode.appendChild(feedback);
            }
            feedback.textContent = 'Attenzione: la data di scadenza √® nel passato';
        } else {
            const feedback = this.parentNode.querySelector('.form-text.date-warning');
            if (feedback) {
                feedback.remove();
            }
        }
    });
}

// Validazione form in tempo reale
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const titoloField = document.getElementById('titolo');
    const descrizioneField = document.getElementById('descrizione');
    const clienteIdField = document.getElementById('cliente-id');
    
    // Validazione titolo
    function validateTitolo() {
        const value = titoloField.value.trim();
        const errorDiv = document.getElementById('titolo-error');
        
        if (!value) {
            titoloField.classList.add('is-invalid');
            if (errorDiv) errorDiv.style.display = 'block';
            return false;
        } else {
            titoloField.classList.remove('is-invalid');
            if (errorDiv) errorDiv.style.display = 'none';
            return true;
        }
    }
    
    // Validazione descrizione
    function validateDescrizione() {
        const value = descrizioneField.value.trim();
        const errorDiv = document.getElementById('descrizione-error');
        
        if (!value) {
            descrizioneField.classList.add('is-invalid');
            if (errorDiv) errorDiv.style.display = 'block';
            return false;
        } else {
            descrizioneField.classList.remove('is-invalid');
            if (errorDiv) errorDiv.style.display = 'none';
            return true;
        }
    }
    
    // Validazione cliente
    function validateCliente() {
        const value = clienteIdField.value;
        const clienteSearch = document.getElementById('cliente-search');
        const errorDiv = document.getElementById('cliente-error');

        if (!value || value === '0' || value === '') {
            clienteSearch.classList.add('is-invalid');
            if (errorDiv) errorDiv.style.display = 'block';
            return false;
        } else {
            clienteSearch.classList.remove('is-invalid');
            if (errorDiv) errorDiv.style.display = 'none';

            // Ricarica le macchine disponibili se √® selezionato il tipo operazione con prestito
            const tipoOperazione = document.getElementById('tipo-operazione-select')?.value;
            if (tipoOperazione === 'riparazione_sede_con_prestito') {
                loadMacchineDisponibili();
            }

            return true;
        }
    }
    
    // Aggiungi event listeners
    titoloField.addEventListener('blur', validateTitolo);
    titoloField.addEventListener('input', function() {
        if (this.value.trim()) {
            validateTitolo();
        }
    });
    
    descrizioneField.addEventListener('blur', validateDescrizione);
    descrizioneField.addEventListener('input', function() {
        if (this.value.trim()) {
            validateDescrizione();
        }
    });
    
    clienteIdField.addEventListener('change', validateCliente);
    
    // Validazione al submit
    form.addEventListener('submit', function(e) {
        const isValidTitolo = validateTitolo();
        const isValidDescrizione = validateDescrizione();
        const isValidCliente = validateCliente();
        
        if (!isValidTitolo || !isValidDescrizione || !isValidCliente) {
            e.preventDefault();
            
            // Scorri al primo errore
            const firstError = document.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
            
            // Mostra un messaggio generale
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Attenzione!</strong> Compila tutti i campi obbligatori prima di salvare il ticket.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Rimuovi alert esistenti
            const existingAlert = form.querySelector('.alert-danger');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // Inserisci l'alert all'inizio del form
            form.insertBefore(alertDiv, form.firstChild);
        }
    });
});

// Funzione per salvare bozza (placeholder)
function saveDraft() {
    // Raccoglie i dati del form
    const formData = new FormData(document.getElementById('ticketForm') || document.getElementById('ticketFormTablet'));
    
    // Salva in localStorage come backup
    const draftData = {
        titolo: formData.get('titolo'),
        descrizione: formData.get('descrizione'),
        cliente: formData.get('cliente'),
        categoria: formData.get('categoria'),
        priorita: formData.get('priorita'),
        stato: formData.get('stato'),
        assigned_to: formData.get('assigned_to'),
        due_date: formData.get('due_date'),
        tempo_stimato: formData.get('tempo_stimato'),
        tags: formData.get('tags'),
        note_interne: formData.get('note_interne'),
        timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('ticket_draft', JSON.stringify(draftData));
    
    // Mostra notifica
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed top-0 end-0 m-3';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle me-2"></i>
                Bozza salvata con successo!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Rimuove il toast dopo che si nasconde
    toast.addEventListener('hidden.bs.toast', () => {
        document.body.removeChild(toast);
    });
}

// Inizializza i gestori per il tipo operazione
function initializeTipoOperazioneHandlers() {
    const tipoOperazioneSelect = document.getElementById('tipo-operazione-select');
    const tipoOperazioneSelectTablet = document.getElementById('tipo-operazione-select-tablet');
    
    if (tipoOperazioneSelect) {
        tipoOperazioneSelect.addEventListener('change', handleTipoOperazioneChange);
    }
    if (tipoOperazioneSelectTablet) {
        tipoOperazioneSelectTablet.addEventListener('change', handleTipoOperazioneChangeTablet);
    }
}

function handleTipoOperazioneChange() {
    const tipoOperazione = document.getElementById('tipo-operazione-select').value;
    const macchineContainer = document.getElementById('macchine-sostitutive-container');
    
    if (tipoOperazione === 'riparazione_sede_con_prestito') {
        macchineContainer.style.display = 'block';
        // Carica sempre le macchine disponibili (non dipende dal cliente)
        loadMacchineDisponibili();
    } else {
        macchineContainer.style.display = 'none';
        clearMacchineSelectionsSostitutive();
    }
}

function handleTipoOperazioneChangeTablet() {
    const tipoOperazione = document.getElementById('tipo-operazione-select-tablet').value;
    const macchineContainer = document.getElementById('macchine-sostitutive-container-tablet');
    
    if (tipoOperazione === 'riparazione_sede_con_prestito') {
        macchineContainer.style.display = 'block';
        // Carica sempre le macchine disponibili (non dipende dal cliente)
        loadMacchineDisponibiliTablet();
    } else {
        macchineContainer.style.display = 'none';
        clearMacchineSelectionsSostitutiveTablet();
    }
}

// Variabile globale per tenere traccia delle macchine sostitutive selezionate
let selectedSubstitutiveMachines = new Set();

// Funzione per caricare le macchine disponibili per il prestito
function loadMacchineDisponibili() {
    // Ottieni il cliente_id selezionato
    const clienteId = document.getElementById('cliente-id')?.value || '';

    // Costruisci l'URL con il parametro cliente_id
    let url = `{{ url_for('tickets.get_macchine_disponibili') }}`;
    if (clienteId) {
        url += `?cliente_id=${clienteId}`;
    }

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.macchine) {
                renderMacchineDisponibili(data.macchine);
            } else {
                showNoMachinesMessageSostitutive();
            }
        })
        .catch(error => {
            console.error('Errore nel caricamento delle macchine disponibili:', error);
            showNoMachinesMessageSostitutive();
        });
}

function loadMacchineDisponibiliTablet() {
    // Ottieni il cliente_id selezionato
    const clienteId = document.getElementById('cliente-id-tablet')?.value || '';

    // Costruisci l'URL con il parametro cliente_id
    let url = `{{ url_for('tickets.get_macchine_disponibili') }}`;
    if (clienteId) {
        url += `?cliente_id=${clienteId}`;
    }

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.macchine) {
                renderMacchineDisponibiliTablet(data.macchine);
            } else {
                showNoMachinesMessageSostitutiveTablet();
            }
        })
        .catch(error => {
            console.error('Errore nel caricamento delle macchine disponibili tablet:', error);
            showNoMachinesMessageSostitutiveTablet();
        });
}

function renderMacchineDisponibili(macchine) {
    const container = document.getElementById('macchine-sostitutive-list');
    const noClientMsg = document.getElementById('no-client-message-sostitutive');
    const noMachinesMsg = document.getElementById('no-machines-message-sostitutive');
    const select = document.getElementById('macchine-sostitutive-select');

    if (noClientMsg) noClientMsg.style.display = 'none';
    if (noMachinesMsg) noMachinesMsg.style.display = 'none';

    if (macchine.length === 0) {
        showNoMachinesMessageSostitutive();
        return;
    }

    // Aggiorna le options del select nascosto con tutte le macchine disponibili
    if (select) {
        select.innerHTML = '';
        macchine.forEach(macchina => {
            const option = document.createElement('option');
            option.value = macchina.id;
            option.textContent = `${macchina.codice} - ${macchina.marca} ${macchina.modello}`;
            select.appendChild(option);
        });

        // Rimetti le selezioni precedenti se sono ancora valide
        selectedSubstitutiveMachines.forEach(id => {
            const option = select.querySelector(`option[value="${id}"]`);
            if (option) {
                option.selected = true;
            }
        });
    }

    container.style.display = 'block';
    container.innerHTML = macchine.map(macchina => {
        const isSelected = selectedSubstitutiveMachines.has(macchina.id);
        return `
        <div class="macchina-item" data-macchina-id="${macchina.id}">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="sostitutiva_${macchina.id}"
                       value="${macchina.id}" onchange="toggleMacchinaSostitutiva(${macchina.id})" ${isSelected ? 'checked' : ''}>
                <label class="form-check-label" for="sostitutiva_${macchina.id}">
                    <strong>${macchina.codice}</strong> - ${macchina.marca} ${macchina.modello}
                    <span class="badge bg-success ms-2">${macchina.stato}</span>
                </label>
            </div>
        </div>
    `}).join('');
}

function renderMacchineDisponibiliTablet(macchine) {
    const container = document.getElementById('macchine-sostitutive-list-tablet');
    const noClientMsg = document.getElementById('no-client-message-sostitutive-tablet');
    const noMachinesMsg = document.getElementById('no-machines-message-sostitutive-tablet');
    const select = document.getElementById('macchine-sostitutive-select-tablet');

    if (noClientMsg) noClientMsg.style.display = 'none';
    if (noMachinesMsg) noMachinesMsg.style.display = 'none';

    if (macchine.length === 0) {
        showNoMachinesMessageSostitutiveTablet();
        return;
    }

    // Aggiorna le options del select nascosto con tutte le macchine disponibili
    if (select) {
        select.innerHTML = '';
        macchine.forEach(macchina => {
            const option = document.createElement('option');
            option.value = macchina.id;
            option.textContent = `${macchina.codice} - ${macchina.marca} ${macchina.modello}`;
            select.appendChild(option);
        });

        // Rimetti le selezioni precedenti se sono ancora valide
        selectedSubstitutiveMachines.forEach(id => {
            const option = select.querySelector(`option[value="${id}"]`);
            if (option) {
                option.selected = true;
            }
        });
    }

    container.style.display = 'block';
    container.innerHTML = macchine.map(macchina => {
        const isSelected = selectedSubstitutiveMachines.has(macchina.id);
        return `
        <div class="macchina-item" data-macchina-id="${macchina.id}">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="sostitutiva_tablet_${macchina.id}"
                       value="${macchina.id}" onchange="toggleMacchinaSostitutiva(${macchina.id})" ${isSelected ? 'checked' : ''}>
                <label class="form-check-label" for="sostitutiva_tablet_${macchina.id}">
                    <strong>${macchina.codice}</strong> - ${macchina.marca} ${macchina.modello}
                    <span class="badge bg-success ms-2">${macchina.stato}</span>
                </label>
            </div>
        </div>
    `}).join('');
}

function toggleMacchinaSostitutiva(macchinaId) {
    if (selectedSubstitutiveMachines.has(macchinaId)) {
        selectedSubstitutiveMachines.delete(macchinaId);
    } else {
        selectedSubstitutiveMachines.add(macchinaId);
    }
    updateHiddenMacchineSelectsSostitutive();
}

function updateHiddenMacchineSelectsSostitutive() {
    const select = document.getElementById('macchine-sostitutive-select');
    const selectTablet = document.getElementById('macchine-sostitutive-select-tablet');
    
    // Aggiorna select desktop
    if (select) {
        select.innerHTML = '';
        selectedSubstitutiveMachines.forEach(id => {
            const option = document.createElement('option');
            option.value = id;
            option.selected = true;
            select.appendChild(option);
        });
    }
    
    // Aggiorna select tablet
    if (selectTablet) {
        selectTablet.innerHTML = '';
        selectedSubstitutiveMachines.forEach(id => {
            const option = document.createElement('option');
            option.value = id;
            option.selected = true;
            selectTablet.appendChild(option);
        });
    }
}

function showNoMachinesMessageSostitutive() {
    const container = document.getElementById('macchine-sostitutive-list');
    const noMachinesMsg = document.getElementById('no-machines-message-sostitutive');
    
    if (container) container.style.display = 'none';
    if (noMachinesMsg) noMachinesMsg.style.display = 'block';
}

function showNoMachinesMessageSostitutiveTablet() {
    const container = document.getElementById('macchine-sostitutive-list-tablet');
    const noMachinesMsg = document.getElementById('no-machines-message-sostitutive-tablet');
    
    if (container) container.style.display = 'none';
    if (noMachinesMsg) noMachinesMsg.style.display = 'block';
}

function clearMacchineSelectionsSostitutive() {
    selectedSubstitutiveMachines.clear();
    updateHiddenMacchineSelectsSostitutive();
}

function clearMacchineSelectionsSostitutiveTablet() {
    selectedSubstitutiveMachines.clear();
    updateHiddenMacchineSelectsSostitutive();
}

// Aggiungi l'inizializzazione al caricamento della pagina
document.addEventListener('DOMContentLoaded', function() {
    initializeTipoOperazioneHandlers();
});

</script>
{% endblock %}



