{% extends "base.html" %}

{% block title %}Cambia Password - DB-Desk{% endblock %}
{% block page_title %}Cambia Password{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-lock"></i>
                    Cambia Password
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Per la sicurezza del tuo account, inserisci la password attuale e quella nuova.
                </div>
                
                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-3">
                        {{ form.current_password.label(class="form-label") }}
                        <div class="input-group">
                            {{ form.current_password(class="form-control" + (" is-invalid" if form.current_password.errors else ""), id="current-password") }}
                            <button class="btn btn-outline-secondary" type="button" id="toggle-current-password">
                                <i class="bi bi-eye" id="current-eye-icon"></i>
                            </button>
                        </div>
                        {% if form.current_password.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.current_password.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.new_password.label(class="form-label") }}
                        <div class="input-group">
                            {{ form.new_password(class="form-control" + (" is-invalid" if form.new_password.errors else ""), id="new-password") }}
                            <button class="btn btn-outline-secondary" type="button" id="toggle-new-password">
                                <i class="bi bi-eye" id="new-eye-icon"></i>
                            </button>
                        </div>
                        {% if form.new_password.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.new_password.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            La password deve essere di almeno 8 caratteri e contenere lettere e numeri.
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        {{ form.confirm_password.label(class="form-label") }}
                        <div class="input-group">
                            {{ form.confirm_password(class="form-control" + (" is-invalid" if form.confirm_password.errors else ""), id="confirm-password") }}
                            <button class="btn btn-outline-secondary" type="button" id="toggle-confirm-password">
                                <i class="bi bi-eye" id="confirm-eye-icon"></i>
                            </button>
                        </div>
                        {% if form.confirm_password.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.confirm_password.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Password strength indicator -->
                    <div class="mb-3">
                        <label class="form-label">Sicurezza password:</label>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" role="progressbar" id="password-strength" style="width: 0%"></div>
                        </div>
                        <small id="password-strength-text" class="form-text text-muted">Inserisci una password</small>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('settings.profile') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i>
                            Torna al Profilo
                        </a>
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Security tips -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-lightbulb"></i>
                    Consigli per la Sicurezza
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success"></i>
                        Usa almeno 8 caratteri
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success"></i>
                        Combina lettere maiuscole e minuscole
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success"></i>
                        Includi almeno un numero
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success"></i>
                        Usa caratteri speciali (@, #, $, etc.)
                    </li>
                    <li class="mb-0">
                        <i class="bi bi-check-circle text-success"></i>
                        Evita parole comuni o dati personali
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Toggle password visibility
function setupPasswordToggle(passwordId, toggleId, iconId) {
    const passwordField = document.getElementById(passwordId);
    const toggleButton = document.getElementById(toggleId);
    const eyeIcon = document.getElementById(iconId);
    
    if (passwordField && toggleButton && eyeIcon) {
        toggleButton.addEventListener('click', function() {
            const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField.setAttribute('type', type);
            
            eyeIcon.className = type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
        });
    }
}

setupPasswordToggle('current-password', 'toggle-current-password', 'current-eye-icon');
setupPasswordToggle('new-password', 'toggle-new-password', 'new-eye-icon');
setupPasswordToggle('confirm-password', 'toggle-confirm-password', 'confirm-eye-icon');

// Password strength checker
const newPasswordField = document.getElementById('new-password');
const strengthBar = document.getElementById('password-strength');
const strengthText = document.getElementById('password-strength-text');

if (newPasswordField && strengthBar && strengthText) {
    newPasswordField.addEventListener('input', function() {
        const password = this.value;
        const strength = calculatePasswordStrength(password);
        
        strengthBar.style.width = strength.percentage + '%';
        strengthBar.className = 'progress-bar ' + strength.colorClass;
        strengthText.textContent = strength.text;
        strengthText.className = 'form-text ' + strength.textClass;
    });
}

function calculatePasswordStrength(password) {
    let score = 0;
    let feedback = [];
    
    if (password.length >= 8) score += 1;
    else feedback.push('almeno 8 caratteri');
    
    if (/[a-z]/.test(password)) score += 1;
    else feedback.push('lettere minuscole');
    
    if (/[A-Z]/.test(password)) score += 1;
    else feedback.push('lettere maiuscole');
    
    if (/[0-9]/.test(password)) score += 1;
    else feedback.push('numeri');
    
    if (/[^A-Za-z0-9]/.test(password)) score += 1;
    else feedback.push('caratteri speciali');
    
    const strengthLevels = [
        { percentage: 0, colorClass: '', textClass: 'text-muted', text: 'Inserisci una password' },
        { percentage: 20, colorClass: 'bg-danger', textClass: 'text-danger', text: 'Molto debole' },
        { percentage: 40, colorClass: 'bg-warning', textClass: 'text-warning', text: 'Debole' },
        { percentage: 60, colorClass: 'bg-info', textClass: 'text-info', text: 'Media' },
        { percentage: 80, colorClass: 'bg-success', textClass: 'text-success', text: 'Forte' },
        { percentage: 100, colorClass: 'bg-success', textClass: 'text-success', text: 'Molto forte' }
    ];
    
    const level = strengthLevels[score] || strengthLevels[0];
    
    if (feedback.length > 0 && password.length > 0) {
        level.text += ` (manca: ${feedback.join(', ')})`;
    }
    
    return level;
}

// Password confirmation validation
const confirmPasswordField = document.getElementById('confirm-password');
if (confirmPasswordField && newPasswordField) {
    confirmPasswordField.addEventListener('input', function() {
        if (this.value && this.value !== newPasswordField.value) {
            this.classList.add('is-invalid');
            this.classList.remove('is-valid');
        } else if (this.value === newPasswordField.value && this.value.length > 0) {
            this.classList.add('is-valid');
            this.classList.remove('is-invalid');
        } else {
            this.classList.remove('is-valid', 'is-invalid');
        }
    });
}

// Focus sul primo campo
document.getElementById('current-password').focus();
</script>
{% endblock %}